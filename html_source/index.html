<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="data:,">
  </head>
  <body>
    <div class="container">
        <div class="my-2 row">
            <div class="col-4 col-lg-7">
                <h5 id="grill-name">Free Grilly </h5>
            </div>
        
            <div class="col-8 col-lg-5 text-end">
                <span class="badge bg-success" id="grill-battery"><i id="grill-battery-charging" class="bi bi-lightning-charge-fill"></i> <span id="grill-battery-percentage">100</span>%</span>
                <span class="badge bg-danger" id="grill-wifi-connected"><i class="bi bi-wifi"></i> <span id="grill-wifi-strength">0%</span></span>
                <a href="/settings" class="btn btn-primary btn-sm"><span class="align-middle"></span>Settings <i class="bi bi-gear align-middle"></i></a>
            </div>
        </div>
        <div class="row pt-1 row-cols-2 row-cols-sm-2 row-cols-md-2 row-cols-lg-4 g-2">
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 1</div>
                            <div class="col-7 probe-temperature text-end" id="probe-1-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-1-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 2</div>
                            <div class="col-7 probe-temperature text-end" id="probe-2-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-2-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 3</div>
                            <div class="col-7 probe-temperature text-end" id="probe-3-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-3-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 4</div>
                            <div class="col-7 probe-temperature text-end" id="probe-4-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-4-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 5</div>
                            <div class="col-7 probe-temperature text-end" id="probe-5-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-5-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 6</div>
                            <div class="col-7 probe-temperature text-end" id="probe-6-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-6-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 7</div>
                            <div class="col-7 probe-temperature text-end" id="probe-7-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-7-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body py-1 px-2">
                        <div class="row">
                            <div class="col-5">Probe 8</div>
                            <div class="col-7 probe-temperature text-end" id="probe-8-temperature">0 C</div>
                            <div class="col-5"><small>Target</small></div>
                            <div class="col-7 probe-temperature text-end"><small id="probe-8-target">0 C</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script type="text/javascript">

        //Only used during tests, the real implementation uses relative urls
        const base_url = "http://10.30.10.235";
        
        const api_polling_interval = 1000;
        const api_unreachable_intervals = 10;

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // Selectors

        const e_probes = new Array(8);
        
        e_probes[1] = {};
        e_probes[2] = {};
        e_probes[3] = {};
        e_probes[4] = {};
        e_probes[5] = {};
        e_probes[6] = {};
        e_probes[7] = {};
        e_probes[8] = {};


        e_probes[1]["temperature"]        = document.getElementById("probe-1-temperature");
        e_probes[2]["temperature"]        = document.getElementById("probe-2-temperature");
        e_probes[3]["temperature"]        = document.getElementById("probe-3-temperature");
        e_probes[4]["temperature"]        = document.getElementById("probe-4-temperature");
        e_probes[5]["temperature"]        = document.getElementById("probe-5-temperature");
        e_probes[6]["temperature"]        = document.getElementById("probe-6-temperature");
        e_probes[7]["temperature"]        = document.getElementById("probe-7-temperature");
        e_probes[8]["temperature"]        = document.getElementById("probe-8-temperature");

        e_probes[1]["target_temperature"] = document.getElementById("probe-1-target");
        e_probes[2]["target_temperature"] = document.getElementById("probe-2-target");
        e_probes[3]["target_temperature"] = document.getElementById("probe-3-target");
        e_probes[4]["target_temperature"] = document.getElementById("probe-4-target");
        e_probes[5]["target_temperature"] = document.getElementById("probe-5-target");
        e_probes[6]["target_temperature"] = document.getElementById("probe-6-target");
        e_probes[7]["target_temperature"] = document.getElementById("probe-7-target");
        e_probes[8]["target_temperature"] = document.getElementById("probe-8-target");
        
        e_grill_name                      = document.getElementById("grill-name");

        e_grill_battery_percentage        = document.getElementById("grill-battery-percentage");
        e_grill_battery_charging          = document.getElementById("grill-battery-charging");
        
        e_wifi_connected                  = document.getElementById("grill-wifi-connected");
        e_wifi_strength                   = document.getElementById("grill-wifi-strength");

        let wifi_signal_strength = 0;

        async function pollTemperatures() {
            
            try {
                const response = await fetch(base_url + "/api/grill");
                data = await response.json();

                console.log(data);     
                
                // Grill name
                e_grill_name.textContent = data.name;
                
                // Battery
                e_grill_battery_percentage.textContent = data.battery_percentage;
                
                // Wifi
                if(data['wifi_connected'] == true){
                    e_wifi_connected.classList.remove("bg-danger");
                    e_wifi_connected.classList.add("bg-success");
                } else {
                    e_wifi_connected.classList.remove("bg-success");
                    e_wifi_connected.classList.add("bg-danger");
                }

                wifi_signal_strength = data['wifi_signal'];

                // battery
                if(data['battery_charging'] == true){
                    e_grill_battery_charging.style.display = "inline-block";
                } else {
                    e_grill_battery_charging.style.display = "none";
                }

                e_wifi_strength.textContent = 140 + wifi_signal_strength + " %";


                for(let probe_nr = 0; probe_nr < 8; probe_nr++)
                {
                    if(data['probes'][probe_nr]['connected'] == true){
                        e_probes[probe_nr + 1]["temperature"].textContent = data['probes'][probe_nr]['temperature'].toFixed(2) + " C";
                    }else{
                        e_probes[probe_nr + 1]["temperature"].textContent = "-";
                    }
                    
                    e_probes[probe_nr + 1]["target_temperature"].textContent = data['probes'][probe_nr]['target_temperature'].toFixed(2) + " C";;
                }

            } catch (error) {
                console.error('Grill is unreachable:', error);
                //TODO set reachable to disabled here once incorporated in webpage
            }

        }
        
        async function pollingLoop() {
            await sleep(api_polling_interval);
            pollTemperatures();
            
            pollingLoop();
        }

        pollingLoop();

    </script>
  </body>
</html>